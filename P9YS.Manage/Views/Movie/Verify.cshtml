
@{
    ViewData["Title"] = "新片审核";
}

<h2>@ViewData["Title"]</h2>
<hr class="layui-bg-black">

<div class="sreachBar">
    <div class="layui-inline">
        <input class="layui-input" name="keyword" placeholder="片名关键词" autocomplete="off">
    </div>
    <div class="layui-form layui-input-inline" style="width:120px">
        <select name="status">
            <option value="" selected>状态</option>
            <option value="0">未处理</option>
            <option value="1">已添加</option>
            <option value="2">已更新</option>
        </select>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">抓取日期</label>
        <div class="layui-input-inline">
            <input type="text" class="layui-input" name="addTime" id="addTime" placeholder=" - ">
        </div>
    </div>
    <button class="layui-btn" id="btn_sreach" data-type="reload">搜索</button>
</div>

<table id="tb_movies" lay-filter="tb_movies"></table>

<form class="layui-form layui-form-pane" id="lay_add" action="" lay-filter="lay_add" style="display:none;margin:15px;">
    <input type="hidden" name="movieDraftId" value="" />
    <div class="layui-form-item">
        <label class="layui-form-label">影片全名</label>
        <div class="layui-input-block">
            <input type="text" name="fullName" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">影片简称</label>
            <div class="layui-input-inline">
                <input type="text" name="shortName" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">导演</label>
            <div class="layui-input-inline">
                <input type="text" name="director" autocomplete="off" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item" style="position:absolute;right:25px;top:63px;">
        <div class="layui-inline">
            <div class="layui-input-inline">
                <img id="imgBox" name="imgUrl" style="max-width:220px;max-height:300px" src="" />
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">其它片名</label>
            <div class="layui-input-inline">
                <textarea name="otherName" rows="3" autocomplete="off" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">演员</label>
            <div class="layui-input-inline">
                <textarea name="actor" rows="3" autocomplete="off" class="layui-textarea"></textarea>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">上映时间</label>
            <div class="layui-input-inline">
                <input type="text" id="releaseDate" name="releaseDate" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">时长(分)</label>
            <div class="layui-input-inline">
                <input type="number" name="movieTime" autocomplete="off" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">评分</label>
            <div class="layui-input-inline">
                <input type="number" name="score" step="0.1" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">评分次数</label>
            <div class="layui-input-inline">
                <input type="number" name="scoreCount" value="20" autocomplete="off" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">豆瓣评分</label>
            <div class="layui-input-inline">
                <input type="number" name="doubanScore" step="0.1" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">豆瓣链接</label>
            <div class="layui-input-inline">
                <input type="text" name="doubanUrl" autocomplete="off" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">关联剧集ID</label>
            <div class="layui-input-inline">
                <input type="number" name="seriesId" autocomplete="off" class="layui-input">
            </div>
        </div>
        @*<div class="layui-inline custom-badge-skin">
                <span class="layui-badge layui-bg-gray">复仇者联盟1</span>
                <span class="layui-badge layui-bg-gray">复仇者联盟2</span>
                <span class="layui-badge layui-bg-gray">复仇者联盟3</span>
            </div>*@
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">国家</label>
        <div class="layui-input-inline">
            <select name="movieAreaId" id="movieAreaId"></select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">类型</label>
        <div class="layui-input-block custom-checkbox-skin">
        </div>
    </div>
    <blockquote class="layui-elem-quote layui-quote-nm">
        <span class="quote-title">资源：</span>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">大小(MB)</label>
                <div class="layui-input-inline">
                    <input type="text" name="movieResource.size" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">分辨率</label>
                <div class="layui-input-inline">
                    <input type="text" name="movieResource.resolution" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">字幕(中)</label>
                <div class="layui-input-inline">
                    <input type="text" name="movieResource.subtitle" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">配音</label>
                <div class="layui-input-inline">
                    <input type="text" name="movieResource.dub" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">链接</label>
                <div class="layui-input-block">
                    <input type="text" name="movieResource.content" autocomplete="off" class="layui-input" />
                </div>
            </div>
        </div>
    </blockquote>
    <blockquote class="layui-elem-quote layui-quote-nm">
        <span class="quote-title">在线播放源：</span>
        <div class="layui-form-item" id="movieOnlinePlays">
            @*<div class="layui-input-inline">
                    <input type="text" name="movieOnlinePlays.webSiteName" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline">
                    <input type="text" name="movieOnlinePlays.price" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline" style="width:410px">
                    <input type="text" name="movieOnlinePlays.url" autocomplete="off" class="layui-input" />
                </div>*@
        </div>
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">简介</label>
        <div class="layui-input-block">
            <textarea name="intro" rows="6" autocomplete="off" class="layui-textarea"></textarea>
        </div>
    </div>
</form>

@section Scripts{
    <script type="text/html" id="operation">
        <a class="layui-btn layui-btn-xs{{d.status!=0?' layui-btn-disabled':''}}" lay-event="edit">处理</a>
    </script>
    <script id="tpl_movieOnlinePlays" type="text/html">
        {{#  layui.each(d, function(index, item){ }}
        <div class="layui-input-inline">
            <input type="text" name="movieOnlinePlays[{{index}}].webSiteName" value="{{ item.webSiteName }}" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-input-inline">
            <input type="text" name="movieOnlinePlays[{{index}}].price" value="{{ item.price }}" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-input-inline" style="width:410px">
            <input type="text" name="movieOnlinePlays[{{index}}].url" value="{{ item.url }}" autocomplete="off" class="layui-input" />
        </div>
        {{#  }); }}
    </script>

    <script>
        layui.use(['table', 'form', 'laydate', 'laytpl'], function () {
            var table = layui.table, form = layui.form, laydate = layui.laydate, laytpl = layui.laytpl;

            //时间控件
            laydate.render({
                elem: '#addTime'
                , range: true //或 range: '~' 来自定义分割字符
                , max: 0//最大日期为当天
            });

            table.render({
                elem: '#tb_movies'
                , url: '/Movie/GetVerifyList' //数据接口
                , method: "get"
                , request: {
                    pageName: "PageIndex"
                    , limitName: "PageSize"
                }
                , page: true //开启分页
                , limit: 20
                , toolbar: '#toolbar'
                , response: {
                    statusCode: 10000 //规定成功的状态码，默认：0
                }
                , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                    return {
                        "code": res.code,
                        "msg": res.message,
                        "count": res.content.totalCount,
                        "data": res.content.data
                    };
                }
                , cols: [[ //表头
                    { field: 'id', title: 'ID', width: 70, fixed: 'left' }
                    , { field: 'movieName', title: '片名', }
                    , { field: 'dyUrl', title: 'dytt', width: 300, }
                    , { field: 'doubanUrl', title: 'douban', width: 300, }
                    , { field: 'resoures', title: 'BT链接', width: 250, }
                    , {
                        field: 'status', title: '状态', width: 100, templet: function (item) {
                            switch (item.status) {
                                case 0:
                                    return "未处理";
                                case 1:
                                    return "已添加";
                                case 2:
                                    return "已更新";
                            }
                        }
                    }
                    , { field: 'addTime', title: '爬取时间', width: 160, }
                    , { title: '', width: 70, fixed: 'right', toolbar: '#operation' }
                ]]
            });

            //监听行工具事件
            table.on('tool(tb_movies)', function (obj) {
                if (obj.event === 'edit' && obj.data.status == 0) { //处理
                    var $form = $("#lay_add");
                    var load = layer.load(2);
                    //form.val("lay_add", obj.data);
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "/Movie/GetMovieDraftDetail",
                        data: { movieDraftId: obj.data.id },
                        success: function (result) {
                            if (result.code == 10000) {
                                result.content.releaseDate = result.content.releaseDate.substr(0, 10);
                                $("#imgBox").attr("src", result.content.imgUrl);
                                result.content.scoreCount = 20;
                                form.val("lay_add", result.content);
                                //类型
                                $.each(result.content.movieTypes, function (idx, item) {
                                    $("input[name='movieTypes'][title='" + item + "']").attr("checked", true);
                                });
                                form.render('checkbox');
                                //movieOnlinePlays
                                var getTpl = tpl_movieOnlinePlays.innerHTML
                                laytpl(getTpl).render(result.content.movieOnlinePlays, function (html) {
                                    $("#movieOnlinePlays").html(html);
                                });
                                //movieResources
                                $("[name='movieResource.size']").val(result.content.movieResource.size);
                                $("[name='movieResource.dub']").val(result.content.movieResource.dub);
                                $("[name='movieResource.resolution']").val(result.content.movieResource.resolution);
                                $("[name='movieResource.subtitle']").val(result.content.movieResource.subtitle);
                                $("[name='movieResource.content']").val(result.content.movieResource.content);

                                layer.open({
                                    title: "审核",
                                    area: ["900px", "88%"],
                                    shade: 0,
                                    type: 1,
                                    content: $form,
                                    btn: ['添加', '取消'],
                                    yes: function () {
                                        var requestBody = $form.serialize();
                                        requestBody += "&imgUrl=" + $("[name='imgUrl']").attr("src");
                                        var load = layer.load(2);
                                        $.ajax({
                                            type: "post",
                                            url: "/Movie/AddMovie",
                                            dataType: "json",
                                            data: requestBody,
                                            success: function (result) {
                                                if (result.code == 10000) {
                                                    layer.closeAll();
                                                    layer.msg('成功', { time: 1000 }, function () {
                                                        location.reload();
                                                    });
                                                } else if (result.code == 10004) {
                                                    layer.closeAll();
                                                    layer.msg(result.message, { icon: 2, time: 1500 }, function () {
                                                        location.reload();
                                                    });
                                                }
                                                else {
                                                    layer.msg(result.message, function () { });
                                                }
                                            },
                                            error: function (ex) {
                                                layer.msg("异常", function () { });
                                            },
                                            complete: function () {
                                                layer.close(load);
                                            }
                                        })
                                    }
                                });
                            }
                        },
                        complete: function () {
                            layer.close(load);
                        }
                    })
                }
            });

            //搜索
            var $ = layui.$, active = {
                reload: function () {
                    var timeArr = $("#addTime").val().split(' - ');
                    var key = {
                        "Condition.keyword": $('[name="keyword"]').val(),
                        "Condition.status": $('[name="status"]').val(),
                        "Condition.beginDate": timeArr[0],
                        "Condition.endDate": timeArr[1],
                    }

                    //执行重载
                    table.reload('tb_movies', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                        , where: key
                    });
                }
            };
            $('#btn_sreach').on('click', function () {
                var type = $(this).data('type'); //reload
                active[type] ? active[type].call(this) : '';
            });

            //国家
            $.ajax({
                type: "get",
                async: false,
                dataType: "json",
                url: "/Setting/GetAreas",
                data: {
                    pageIndex: 1,
                    pageSize: 100
                },
                success: function (result) {
                    if (result.code == 10000) {
                        var html = "";
                        $.each(result.content.data, function (idx, item) {
                            html += '<option value="' + item.id + '">' + item.area + '</option >';
                        })
                        $("#movieAreaId").html(html);
                        //更新渲染
                        form.render('select');
                    }
                }
            })

            //类型
            $.ajax({
                type: "get",
                async: false,
                dataType: "json",
                url: "/Setting/GetGenres",
                data: {
                    pageIndex: 1,
                    pageSize: 100
                },
                success: function (result) {
                    if (result.code == 10000) {
                        var html = "";
                        $.each(result.content.data, function (idx, item) {
                            html += '<input type="checkbox" name="movieTypes" value="' + item.id + '" title="' + item.name + '">';
                        })
                        $(".custom-checkbox-skin").html(html);
                        //更新渲染
                        form.render('checkbox');
                    }
                }
            })
        });
    </script>
}




