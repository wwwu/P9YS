function GetReplyList(n,t,i){var r=layer.load(3,{shade:[.1,"#000"]});$.ajax({type:"get",dataType:"json",url:"/Movie/GetQuestionAnswers",data:{questionId:i,pageIndex:n,pageSize:t},success:function(i){if(i.code==1e4){var u="",f=i.content.data;$.each(f,function(n,t){u+="<div class='reply-box'>\n                                <img class='avatar pull-left' src='"+t.userAvatar+"' height='38' width='38'>\n                                <p class='u-info'><span class='pull-right glyphicon glyphicon-thumbs-up' data-id='"+t.id+"' title='赞'><font>"+t.support+"<\/font><\/span>"+t.userNickName+" &nbsp;&nbsp; "+t.addTime+"<\/p>\n                                <pre>"+t.content+"<\/pre>\n                            <\/div><hr />"});$(".question-result").html(u);$(".question-detail .rowsCount").html(i.content.totalCount);$(".question-detail .pagination").html(paging(n,i.content.totalCount,t,3))}i.Code>0;layer.close(r)}})}function search(n,t){var i=layer.load(3,{shade:[.1,"#000"]}),f=$(".cdt-area .label-primary").attr("data-id"),e=$(".cdt-type .label-primary").attr("data-id"),o=$(".cdt-time .label-primary").attr("data-start"),s=$(".cdt-time .label-primary").attr("data-end"),h=$(".cdt-sort .label-primary").attr("data-id"),r=20,u;t||(t=$(".pagination li.active a").attr("data-page")-0,t=t?t:1);u={pageIndex:t,pageSize:r,condition:{movieAreaId:f,movieTypeId:e,beginDate:o,endDate:s,sort:h,keyword:n}};$.ajax({type:"post",url:"/Movie/GetPageList",dataType:"json",contentType:"application/json",data:JSON.stringify(u),success:function(n){if(n.code==1e4){var u="";$.each(n.content.data,function(n,t){u+="<div class='col-xs-6 col-md-2'><a href='/movie/"+t.id+"' target='_blank' class='thumbnail'><img alt='"+t.shortName+"' src='"+t.imgUrl+"'><\/a><div class='intro'><p title='"+t.shortName+"'><span>"+Number(t.score).toFixed(1)+"<\/span>"+t.shortName+"<\/p><\/div><\/div>"});u==""&&(u="<p style='padding-left:14px;'><span class='glyphicon glyphicon-exclamation-sign'><\/span> 没有找到结果。<\/p>");$(".search-result .list-movies").html(u);$(".search-result .pagination").html(paging(t,n.content.totalCount,r,3))}else layer.msg(n.message,function(){});layer.close(i)},error:function(){layer.close(i);layer.msg("系统异常，请稍后再试！")}})}function countDown(n,t,i,r){function u(n){timer1=setInterval(function(){t.val(i+"["+--n+"]");n<1&&(t.removeClass(r),t.val(i),clearInterval(timer1))},1e3)}t.addClass(r);u(n)}function getUrlParam(n){var i=new RegExp("(^|&)"+n+"=([^&]*)(&|$)"),t=window.location.search.substr(1).match(i);return t!=null?decodeURIComponent(t[2]):null}function paging(n,t,i,r){var f="",e,o,u;if(n=parseInt(n),t=parseInt(t),i=parseInt(i),r=parseInt(r),e=Math.ceil(t/i),t==0)return f;for(f+=n==1?"<li class='disabled'><a href='javascript:void(0)'>&laquo;<\/a><\/li>":"<li><a data-toggle='tooltip' data-placement='top' title='第"+(n-1)+"页' href='javascript:void(0)' data-page='"+(n-1)+"'>&laquo;<\/a><\/li><li><a data-toggle='tooltip' data-placement='top' title='第1页' href='javascript:void(0)' data-page='1'>1<\/a><\/li>",n>r+2&&(f+="<li><a data-toggle='tooltip' data-placement='top' title='第"+(n-r-1)+"页' href='javascript:void(0)' data-page='"+(n-r-1)+"'>...<\/a><\/li>"),o="",u=n-1;u>n-(r+1)&&u>1;u--)o="<li><a data-toggle='tooltip' data-placement='top' title='第"+u+"页' href='javascript:void(0)' data-page='"+u+"'>"+u+"<\/a><\/li>"+o;for(f+=o,f+="<li class='active'><a data-toggle='tooltip' data-placement='top' title='第"+n+"页' href='javascript:void(0)'  data-page='"+n+"'>"+n+"<\/a><\/li>",u=n+1;u<n+(r+1)&&u<e;u++)f+="<li><a data-toggle='tooltip' data-placement='top' title='第"+u+"页' href='javascript:void(0)' data-page='"+u+"'>"+u+"<\/a><\/li>";return n+r+1<e&&(f+="<li><a data-toggle='tooltip' data-placement='top' title='第"+(n+r+1)+"页' href='javascript:void(0)' data-page='"+(n+r+1)+"'>...<\/a><\/li>"),f+(n==e?"<li class='disabled'><a href='javascript:void(0)'>&raquo;<\/a><\/li>":"<li><a data-toggle='tooltip' data-placement='top' title='第"+e+"页' href='javascript:void(0)' data-page='"+e+"'>"+e+"<\/a><\/li><li><a data-toggle='tooltip' data-placement='top' title='第"+(n+1)+"页' href='javascript:void(0)'  data-page='"+(n+1)+"'>&raquo;<\/a><\/li>")}$(function(){function t(n,t,i){var r=layer.load(3,{shade:[.1,"#000"]});$.ajax({type:"get",dataType:"json",url:"/Movie/GetMovieComments",data:{condition:i,pageIndex:n,pageSize:t},success:function(i){if(i.code==1e4){var u="",f=i.content.data;$.each(f,function(n,t){u+="<div><img class='avatar pull-left' src='"+t.userAvatar+"' height='38' width='38'>\n                            <p class='u-info'>"+t.userNickName+' &nbsp;&nbsp; <span class="pull-right">'+t.addTime+"<\/span><\/p>\n                            <p class='conment-cnt'>"+t.content+"<\/p>\n";u+="<\/div>\n<hr />\n"});$(".comment-result").html(u);$(".comment .pagination").html(paging(n,i.content.totalCount,t,3));$(document).scrollTop(0)}else layer.msg(i.message,function(){});layer.close(r)}})}function i(n,t,i){var r=layer.load(3,{shade:[.1,"#000"]});$.ajax({type:"get",dataType:"json",url:"/Movie/GetQuestions",data:{condition:i,pageIndex:n,pageSize:t},success:function(i){if(i.code==1e4){var u="",f=i.content.data;$.each(f,function(n,t){u+="<p><span class='pull-right'>回答("+t.answerCount+")<\/span><a target='_blank' href='/movie/question/"+t.id+"'>"+t.title+"<\/a><\/p>\n"});$(".question-result").html(u);$(".question .badge").html(i.content.totalCount);$(".question .pagination").html(paging(n,i.content.totalCount,t,3));$(document).scrollTop(0)}else layer.msg(i.message,function(){});layer.close(r)}})}$(document).on("mouseover","[data-toggle='tooltip']",function(){$(this).tooltip("show")});$("#btn_global_search").click(function(){var n=$("#ipt_global_search").val().trim();n!=""&&window.open("/?kw="+encodeURIComponent(n))});$("#ipt_global_search").keyup(function(){event.keyCode==13&&$("#btn_global_search").click()});var n=getUrlParam("kw");n&&($("#ipt_global_search").val(n),search(n));$("#panel-login .btn-login").click(function(n){var t,i;(n.preventDefault(),t=$("#panel-login form"),t.valid())&&(i=t.serialize(),$.ajax({type:"post",url:"/Member/Login",dataType:"json",data:i,success:function(n){if(n.code==1e4){$("#panel-login .close").click();layer.msg("登录成功");var t=getUrlParam("returnUrl");t!=null?location.href=t:$(".nav-login").html("<p>{0}<br />{1} <a href='/Member/Logout'>注销<\/a><\/p><a href='/account/index'><img class='avatar' src='{2}' height='42' width='42' /><\/a>".format(n.content.nickName,n.content.email,n.content.avatar))}else layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}}))});$("#panel-register .btn-verifyCode").click(function(){var n=$(this),t="dis_vc",i=$("#RegisterInput_Email");!$(this).hasClass(t)&&i.valid()&&$.ajax({type:"post",dataType:"json",url:"/Member/SendVerifyCode",data:{email:i.val()},success:function(i){i.code==1e4?(layer.msg("验证码已发送"),countDown(60,n,n.val(),t)):layer.msg(i.message,function(){})},error:function(){layer.msg("异常",function(){})}})});$("#panel-register .btn-register").click(function(n){var t,i;(n.preventDefault(),t=$("#panel-register form"),t.valid())&&(i=t.serialize(),$.ajax({type:"post",url:"/Member/Register",dataType:"json",data:i,success:function(n){n.code==1e4?location.href="/account/index":layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}}))});$(".condition .label").click(function(){$(this).hasClass("label-primary")||$(this).hasClass("lb-more")||($parent=$(this).parent(),$parent=$parent.hasClass("more")?$parent.parent():$parent,$parent.find(".label-primary").addClass("label-default").removeClass("label-primary"),$(this).addClass("label-primary").removeClass("label-default"),$(this).hasClass("cdt-time-custom")?$("#datetimeStart,#datetimeEnd,.btn-year-confirm").prop("disabled",!1):($parent.hasClass("cdt-time")&&$("#datetimeStart,#datetimeEnd,.btn-year-confirm").prop("disabled",!0),search(null,1)))});$(".btn-year-confirm").click(function(){var n=$("#datetimeStart").val(),t=$("#datetimeEnd").val();$(".cdt-time-custom").attr({"data-start":n,"data-end":t});search(null,1)});$(".rating").on("change",function(){var t=$("#movieId").val(),i=$(this).val(),n;$(this).rating("refresh",{disabled:!0});n={movieId:t,score:i};$.ajax({type:"post",dataType:"json",url:"/Movie/MovieRating",contentType:"application/json",data:JSON.stringify(n),success:function(n){n.code==1e4?layer.msg("感谢支持！"):n.code==11005?$("#panel-login").modal():layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}})});$("#btn-comment").click(function(){var i=$("#movieId").val(),n=$("#txt-comment").val().trim(),t;if(n.length<2){layer.msg("能再短一点？",function(){});return}t={movieId:i,content:n};$.ajax({type:"post",dataType:"json",url:"/Movie/AddMovieComment",headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()},contentType:"application/json",data:JSON.stringify(t),success:function(n){n.code==1e4?location.href=location.href:n.code==11005?$("#panel-login").modal():layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}})});$(".comment .pagination").on("click","li:not('.disabled,.active') a",function(){var n=$(this).attr("data-page"),i=$("#movieId").val();t(n,10,i)});$("#btn-question").click(function(){var i=$("#movieId").val(),n=$("#txt-question-title").val().trim(),r=$("#txt-question-content").val().trim(),t;if(n.length<5){layer.msg("标题过短",function(){});return}t={movieId:i,title:n,content:r};$.ajax({type:"post",dataType:"json",url:"/Movie/AddQuestion",headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()},contentType:"application/json",data:JSON.stringify(t),success:function(n){n.code==1e4?location.href=location.href:n.code==11005?$("#panel-login").modal():layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}})});$(".question .pagination").on("click","li:not('.disabled,.active') a",function(){var n=$(this).attr("data-page"),t=$("#movieId").val();i(n,20,t)});$(".question-detail .pagination").on("click","li:not('.disabled,.active') a",function(){var n=$(this).attr("data-page"),t=$("#questionId").val();GetReplyList(n,10,t)});$(".question-detail #btn-reply").click(function(){var n=$("#txt-question-reply").val().trim(),t;if(n.length<2){layer.msg("能再短一点？",function(){});return}t={movieQuestionId:$("#questionId").val(),content:n};$.ajax({type:"post",dataType:"json",url:"/Movie/AddQuestionAnswer",headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()},contentType:"application/json",data:JSON.stringify(t),success:function(n){n.code==1e4?location.href=location.href:n.code==11005?$("#panel-login").modal():layer.msg(n.message,function(){})},error:function(){layer.msg("异常",function(){})}})});$(".question-detail").on("click","span.glyphicon-thumbs-up",function(){var n=$(this),t;n.css("cursor")!="default"&&(t={answerId:n.attr("data-id")},$.ajax({type:"post",dataType:"json",url:"/Movie/SupportAnswer",contentType:"application/json",data:JSON.stringify(t),success:function(t){if(t.code==1e4){if(t.content){layer.msg("赞 +1");var i=parseInt(n.find("font").html())+1;n.find("font").html(i)}}else t.code==11005?$("#panel-login").modal():layer.msg(t.message,function(){})},error:function(){layer.msg("异常",function(){})}}))});$(".upd-password .btn").click(function(){var t=$(".upd-password .oldPwd").val(),n=$(".upd-password .newPwd").val(),i=$(".upd-password .newPwdAg").val();if(t==""||n==""||i==""){layer.msg("请填写完整",function(){});return}if(n.length<6){layer.msg("密码太短",function(){});return}if(n!=i){layer.msg("两次输入的密码不一致",function(){});return}$.ajax({type:"post",dataType:"json",url:"/account/UpdPassword",data:{oldPwd:t,newPwd:n},success:function(n){n.Code==1?(layer.msg("修改成功"),$(".upd-password input[type='password']").val("")):layer.msg("密码错误！",function(){})}})});$(".upd-nickname").click(function(){var n=layer.open({type:1,title:"修改昵称",btn:["确定"],area:["300px","170px"],content:$(".lay-nickname"),yes:function(){var t=$(".new-nickname").val().trim();t!=""&&$.ajax({type:"post",dataType:"json",url:"/account/UpdNickname",data:{newNickname:t},success:function(i){i.Code==1?(layer.msg("修改成功"),$("#nickname").html(t),layer.close(n)):layer.msg("该昵称已存在...",function(){})}})}})});$(document).on("keyup",".only-num",function(){$(this).val($(this).val().replace(/[^\d]|^0/g,""))})});String.prototype.format=function(n){var i=this,r,t,u;if(arguments.length>0)if(arguments.length==1&&typeof n=="object")for(r in n)n[r]!=undefined&&(u=new RegExp("({"+r+"})","g"),i=i.replace(u,n[r]));else for(t=0;t<arguments.length;t++)arguments[t]!=undefined&&(u=new RegExp("({)"+t+"(})","g"),i=i.replace(u,arguments[t]));return i};